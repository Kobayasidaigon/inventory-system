# アップグレードガイド: ユーザー権限システム導入

このガイドは、既存の在庫管理システムを新しいユーザー権限システムにアップグレードする手順を説明します。

## 新機能

### 1. ユーザーロール管理
- **一般ユーザー**: 現在庫確認・出庫・入庫・発注希望のみ
- **管理者**: すべての機能にアクセス可能

### 2. 発注承認フロー
- 一般ユーザーが発注希望を送信
- 管理者が発注数を調整して承認・却下
- お盆前などの特別な状況に対応可能

### 3. 発注点の手動管理
- 発注点の自動更新を廃止
- 推奨発注点は参考値として表示
- 管理者が手動で適用

### 4. 都度出庫機能
- 日付を指定して出庫記録
- 今日の出庫履歴を表示

## アップグレード手順

### ステップ1: データベースマイグレーション

既存のデータベースに新しいカラムとテーブル構造を追加します。

```bash
# マイグレーションスクリプトを実行
npm run migrate
```

マイグレーション内容：
- `users` テーブルに `role` カラムを追加
- 既存のadminユーザーに管理者ロールを付与
- `order_requests` テーブルを再構築（承認フロー対応）

### ステップ2: コードの更新

```bash
# 最新のコードに更新
git pull origin main

# 依存パッケージを更新（念のため）
npm install
```

### ステップ3: サーバーの再起動

```bash
# サーバーを停止（Ctrl+C）

# サーバーを再起動
npm start
```

### ステップ4: 動作確認

#### 1. ログイン確認
- 既存のadminアカウントでログイン
- 管理者として全機能にアクセスできることを確認

#### 2. 一般ユーザーの作成
管理者としてログインし、ブラウザの開発者ツール（F12）のコンソールで以下を実行：

```javascript
fetch('/api/auth/register', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({
        username: 'staff1',
        password: 'password123',
        role: 'user'
    })
}).then(res => res.json()).then(console.log);
```

#### 3. 一般ユーザーでログイン
- 作成した一般ユーザーでログイン
- 現在庫・出庫・入庫・発注希望のみ表示されることを確認

#### 4. 発注フローのテスト
1. 一般ユーザーで発注希望を送信
2. 管理者でログインして発注管理ページを開く
3. 発注数を調整して承認
4. 一般ユーザーで発注承認済みが表示されることを確認

## Fly.ioへのデプロイ

### 1. マイグレーションの実行

```bash
# SSHでコンテナに接続
flyctl ssh console -a inventory-system-aburiva

# マイグレーションを実行
cd /app
npm run migrate
exit
```

### 2. アプリケーションのデプロイ

```bash
# 最新のコードをデプロイ
flyctl deploy -a inventory-system-aburiva
```

### 3. 動作確認

ブラウザでアプリケーションにアクセスし、上記の動作確認を実施。

## トラブルシューティング

### マイグレーションエラー

**エラー**: `duplicate column name: role`

**原因**: すでにマイグレーション済み

**対処**: 問題ありません。すでに最新の構造です。

---

### ログイン後にロールが表示されない

**原因**: セッションに古い情報が残っている

**対処**: 一度ログアウトして再ログイン

---

### 一般ユーザーなのに管理者機能が見える

**原因**: ブラウザキャッシュが古い

**対処**: ブラウザのキャッシュをクリア（Ctrl+Shift+R）

---

### 発注希望が送信できない

**エラー**: `403 Forbidden`

**原因**: APIエンドポイントの権限設定

**対処**: サーバーログを確認し、`requireAuth` ミドルウェアが正しく動作しているか確認

## ロールバック手順

万が一問題が発生した場合のロールバック手順：

```bash
# データベースのバックアップから復元
cp server/db/inventory.db.backup server/db/inventory.db

# 旧バージョンのコードに戻す
git checkout <previous-commit-hash>

# サーバー再起動
npm start
```

## 新しい機能の使い方

### 一般ユーザー向け

1. **現在庫確認**: 全商品の在庫状況を確認できます
2. **出庫**: 商品が売れたら都度記録できます
3. **入庫**: 商品が届いたら記録できます
4. **発注希望**: 在庫が少ない商品の発注を希望できます

### 管理者向け

1. **発注管理**: 一般ユーザーからの発注希望を確認・承認・却下
2. **発注数調整**: お盆前などで数量を変更可能
3. **商品マスター**: 発注点の設定、推奨値の確認と適用
4. **週次入力**: 過去データの一括修正用として使用

## サポート

問題が発生した場合は、以下の情報を含めて報告してください：

- エラーメッセージ
- サーバーログ（`npm start` の出力）
- ブラウザのコンソールログ（F12で確認）
- 実行した操作の手順
