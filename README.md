# 週次在庫管理システム

小売店向けの週次在庫管理システムです。紙で管理した在庫の増減を週単位でまとめて入力できます。

## 機能

- **商品マスター管理**: 商品の登録・編集・削除、画像アップロード対応
- **週次在庫入力**: 紙の記録を週単位でまとめて入力、商品画像表示
- **入庫処理**: 商品が追加されたタイミングで随時入力、商品画像表示
- **在庫状況確認**: 現在庫と発注点の確認、カテゴリフィルター対応
- **履歴管理**: 入出庫履歴の確認と修正、カテゴリ・商品フィルター対応
- **在庫推移グラフ**: 商品ごとの在庫推移をグラフで可視化、発注分析機能
- **CSVエクスポート**: 在庫データと履歴のExcel出力
- **レスポンシブ対応**: PC・タブレット・スマートフォンに対応
- **マルチテナント**: ユーザーごとに独立したデータベース（オプション）

## セットアップ

### 必要環境
- Node.js (v14以上)
- npm

### インストール手順

1. プロジェクトディレクトリに移動
```bash
cd inventory-system
```

2. 依存パッケージをインストール
```bash
npm install
```

3. サーバーを起動
```bash
npm start
```

開発モード（自動再起動）で起動する場合：
```bash
npm run dev
```

4. ブラウザでアクセス
```
http://localhost:3000
```

## 使い方

### 初回セットアップ（管理者アカウント作成）

初回起動時は管理者アカウントを作成する必要があります。

#### 方法1: セットアップ画面から作成（推奨）
ブラウザで以下のURLにアクセス：
```
http://localhost:3000/setup.html
```
管理者IDとパスワードを入力して作成してください。

**注意**: このページは初回のみアクセス可能です。管理者アカウントが作成された後はアクセスできなくなります。

#### 方法2: APIエンドポイントから作成
curlコマンドで直接作成することも可能です：
```bash
curl -X POST http://localhost:3000/api/auth/admin/init \
  -H "Content-Type: application/json" \
  -d '{"username":"admin","password":"your-password"}'
```

**セキュリティ注意**:
- 本番環境では強固なパスワードを設定してください
- 管理者アカウントは1つのみ作成可能です
- 一度作成すると、上記の方法では追加作成できません

### ログイン
管理者アカウント作成後、ログイン画面から管理者としてログインできます。

### 基本的な運用フロー

1. **商品登録**
   - 「商品管理」タブから新規商品を登録
   - 商品名、カテゴリ、発注点、標準在庫数を設定

2. **初期在庫設定**
   - 商品管理画面の「初期在庫」ボタンから現在の在庫数を入力

3. **日々の運用**
   - 紙で在庫の減少を記録

4. **週次入力**
   - 「週次入力」タブから期間を設定
   - 各商品の出庫数（減少数）を入力して一括登録

5. **入庫処理**
   - 商品が入荷したら「入庫処理」タブから随時入力

6. **在庫確認**
   - ダッシュボードで発注が必要な商品を確認
   - CSVボタンでExcelファイルとして出力

### 履歴の修正
- 「履歴確認」タブから過去の入力を修正可能

## データベース

SQLiteを使用しているため、データは `server/db/inventory.db` ファイルに保存されます。
バックアップが必要な場合は、このファイルをコピーしてください。

## トラブルシューティング

### ポート3000が使用中の場合
環境変数でポートを変更できます：
```bash
PORT=3001 npm start
```

### データベースをリセットしたい場合
```bash
rm server/db/inventory.db
npm start
```
（サーバー起動時に自動的に新しいデータベースが作成されます）

## マルチテナント機能

### 概要
マルチテナント機能を有効にすると、ユーザーごとに独立したデータベースが作成されます。
異なるユーザーでログインすると、それぞれ別のデータを管理できます。

### 有効化方法
`.env`ファイルに以下を追加：

```env
MULTI_TENANT=true
DB_DIR=/data  # データベースファイルの保存先
```

### 使い方
1. マルチテナントモードを有効化
2. アプリケーションを起動
3. 新規ユーザーを登録（`POST /api/auth/register`エンドポイント使用）
4. 各ユーザーでログインすると、専用のDBが使用される

## Fly.ioへのデプロイ

本システムは無料でFly.ioにデプロイできます。詳細は [DEPLOY.md](./DEPLOY.md) を参照してください。

### 簡易手順

```bash
# Fly.ioにログイン
flyctl auth login

# アプリケーションを作成
flyctl launch

# ボリュームを作成（データ永続化）
flyctl volumes create inventory_data --region nrt --size 1

# 環境変数を設定
flyctl secrets set MULTI_TENANT=true
flyctl secrets set DB_DIR=/data
flyctl secrets set SESSION_SECRET=your-secret-key

# デプロイ
flyctl deploy
```

## セキュリティ注意事項

- 本番環境で使用する場合は、必ず初期パスワードを変更してください
- セッションシークレットキーを環境変数で管理することを推奨します
- マルチテナント機能を使用する場合、ユーザー登録エンドポイントへのアクセス制御を検討してください# inventory-system
