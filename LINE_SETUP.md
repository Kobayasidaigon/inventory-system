# LINE通知機能 セットアップ手順

在庫が発注点を下回った際に、LINEグループへ自動通知を送る機能のセットアップ手順です。

## 1. LINE Messaging APIの設定

### 1-1. LINE Developersコンソールにアクセス
1. [LINE Developers](https://developers.line.biz/)にアクセス
2. LINEアカウントでログイン

### 1-2. プロバイダーの作成
1. 「プロバイダー」タブから「新規プロバイダー作成」をクリック
2. プロバイダー名を入力（例: 在庫管理システム）

### 1-3. Messaging APIチャネルの作成
1. 作成したプロバイダーを選択
2. 「新規チャネル作成」→「Messaging API」を選択
3. 必要な情報を入力:
   - チャネル名: 在庫管理Bot（任意）
   - チャネル説明: 在庫管理システムの発注通知Bot
   - 大業種・小業種: 適切なものを選択
   - メールアドレス: 管理者のメールアドレス
4. 利用規約に同意してチャネルを作成

### 1-4. チャネルアクセストークンの発行
1. 作成したチャネルの「Messaging API設定」タブを開く
2. 「チャネルアクセストークン（長期）」の「発行」ボタンをクリック
3. 発行されたトークンをコピーして保存（後で使用）

### 1-5. チャネルシークレットの取得
1. 「チャネル基本設定」タブを開く
2. 「Channel secret」をコピーして保存（後で使用）

### 1-6. Webhook設定（グループID取得のため一時的に有効化）
1. 「Messaging API設定」タブに戻る
2. Webhook設定:
   - Webhook URL: `https://your-domain.com/api/line/webhook`
     （デプロイ後のドメインに置き換え）
   - Webhookの利用: 「オン」に設定
3. 自動応答メッセージ設定:
   - 「LINE公式アカウント機能」の「編集」をクリック
   - 応答メッセージ: 「オフ」に設定
   - あいさつメッセージ: 「オフ」に設定

## 2. 環境変数の設定

### 2-1. .envファイルの作成・編集
プロジェクトのルートディレクトリに`.env`ファイルを作成（既にある場合は編集）:

```env
# LINE Messaging API設定
LINE_CHANNEL_ACCESS_TOKEN=取得したチャネルアクセストークンをここに貼り付け
LINE_CHANNEL_SECRET=取得したチャネルシークレットをここに貼り付け
```

## 3. LINEグループの準備とBotの追加

### 3-1. LINEグループの作成
1. LINEアプリで通知を受け取りたいグループを作成（既存のグループでもOK）
2. グループ名を設定（例: 在庫管理通知）

### 3-2. Botをグループに追加
1. LINE Developersコンソールで、チャネルのQRコードを表示
2. LINEアプリでQRコードを読み取り、Botを友だち追加
3. Botをグループに招待

## 4. グループIDの取得

グループIDを取得する方法は2つあります。

### 方法A: Webhookを使用（推奨）

1. サーバーを起動:
   ```bash
   npm start
   ```

2. サーバーのログを確認できる状態にする

3. LINEグループ内で、Botに向けてメンションまたは何かメッセージを送信
   例: 「@在庫管理Bot テスト」

4. サーバーのログに以下のように表示される:
   ```
   ==========================================
   📍 LINEグループID: C1234567890abcdef...
   このIDを .env ファイルに設定してください:
   LINE_NOTIFICATION_GROUP_ID=C1234567890abcdef...
   ==========================================
   ```

5. 表示されたグループIDをコピー

### 方法B: 管理者画面からテスト送信

1. 管理者としてログイン

2. ブラウザのコンソールを開く（F12キー）

3. 以下のコマンドを実行:
   ```javascript
   fetch('/api/line/broadcast', {
       method: 'POST',
       headers: { 'Content-Type': 'application/json' }
   }).then(r => r.json()).then(console.log)
   ```

4. LINEグループにメッセージが届くので、グループ内で返信

5. サーバーのログからグループIDを確認

## 5. グループIDの設定

### 5-1. データベースに保存（管理者画面から）

1. 管理者としてログイン

2. ブラウザのコンソールを開く（F12キー）

3. 以下のコマンドで取得したグループIDをテスト:
   ```javascript
   fetch('/api/line/test', {
       method: 'POST',
       headers: { 'Content-Type': 'application/json' },
       body: JSON.stringify({ groupId: '取得したグループID' })
   }).then(r => r.json()).then(console.log)
   ```

4. LINEグループにテストメッセージが届けば成功

## 6. 動作確認

### 6-1. 在庫を発注点以下にして確認
1. 各店舗のダッシュボードにログイン
2. 商品の出庫処理を行い、在庫を発注点以下に
3. LINEグループに以下のような通知が届くことを確認:

```
📦 発注依頼通知

店舗: 〇〇店 (001)
商品: △△商品
現在庫: 5
発注点: 10
発注数量: 15

⚠️ 在庫が発注点を下回りました。
```

## 7. Webhook設定の無効化（オプション）

グループIDの取得が完了したら、Webhookを無効化できます:

1. LINE Developersコンソールの「Messaging API設定」タブ
2. Webhookの利用: 「オフ」に設定

※ 無効化しても、プッシュメッセージ（通知）の送信は可能です

## トラブルシューティング

### 通知が届かない場合

1. **環境変数の確認**
   - `LINE_CHANNEL_ACCESS_TOKEN`と`LINE_CHANNEL_SECRET`が正しく設定されているか
   - サーバーを再起動したか

2. **グループIDの確認**
   - データベースに正しいグループIDが保存されているか
   - `/api/line/settings`エンドポイントで確認可能

3. **Botがグループに参加しているか**
   - LINEグループのメンバー一覧にBotが表示されているか

4. **サーバーログの確認**
   - `LINE通知を送信しました`のログが出力されているか
   - エラーメッセージがないか

### よくあるエラー

**エラー: "LINE クライアントが初期化されていません"**
- 原因: 環境変数が設定されていない
- 解決: `.env`ファイルを確認し、サーバーを再起動

**エラー: "Invalid reply token"**
- 原因: Webhookの設定が正しくない
- 解決: Webhook URLを確認し、HTTPSでアクセス可能か確認

## 参考リンク

- [LINE Messaging API ドキュメント](https://developers.line.biz/ja/docs/messaging-api/)
- [LINE Developers コンソール](https://developers.line.biz/console/)
